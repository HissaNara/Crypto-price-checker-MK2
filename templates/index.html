<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTC Price Viewer</title>
  <style>
    html, body { margin: 0; padding: 0; font-family: system-ui, sans-serif; height: 100%; }
    :root { --bg-color:#fafafa; --fg-color:#121212; --accent-up:#009900; --accent-down:#c00000; }
    [data-theme="dark"] { --bg-color:#121212; --fg-color:#fafafa; }
    body { background:var(--bg-color); color:var(--fg-color); display:flex; align-items:center; justify-content:center; min-height:100dvh; transition:background 0.3s,color 0.3s; }
    .container { text-align:center; font-size:1.5rem; }
    .price { font-size:2.5rem; }
    .price .decimal { transition:color 0.3s; }
    .timestamp { font-size:0.8rem; opacity:0.7; }
    .toggle { position:fixed; top:1rem; left:1rem; padding:0.4rem; border-radius:0.4rem; background:none; border:none; font-size:0.9rem; cursor:pointer; color:inherit; }
  </style>
</head>
<body>
  <button class="toggle" id="themeToggle" aria-label="Toggle dark mode">ðŸŒ“</button>
  <div class="container">
    <div class="symbol" id="symbol">BTCUSDT</div>
    <div class="price" id="price">--<span class="decimal">.--</span></div>
    <div class="timestamp" id="timestamp">--</div>
  </div>
  <script>
    const initialPrice = {{ price|tojson }};
    const initialTime = {{ time|tojson }};
    const priceElem = document.getElementById('price');
    const decimalElem = priceElem.querySelector('.decimal');
    const timestampElem = document.getElementById('timestamp');
    // ãƒ†ãƒ¼ãƒžåˆ‡æ›¿
    const themeToggle = document.getElementById('themeToggle');
    const applyTheme = theme => { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); };
    const saved = localStorage.getItem('theme'); if(saved) applyTheme(saved);
    else if(window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');
    themeToggle.addEventListener('click',()=>{ const cur=document.documentElement.getAttribute('data-theme')||'light'; applyTheme(cur==='light'?'dark':'light');});
    let previousPrice = null;
    function updateDisplay(p, t) {
      if(!p) return;
      const [intPart, decPart] = parseFloat(p).toFixed(2).split('.');
      priceElem.firstChild.nodeValue = intPart;
      decimalElem.textContent = '.' + (decPart || '00');
      timestampElem.textContent = t || '';
      if(previousPrice !== null) {
        const prev = parseFloat(previousPrice);
        const curr = parseFloat(p);
        if(curr > prev) decimalElem.style.color = getComputedStyle(document.documentElement).getPropertyValue('--accent-up');
        else if(curr < prev) decimalElem.style.color = getComputedStyle(document.documentElement).getPropertyValue('--accent-down');
      }
      previousPrice = p;
    }
    if(initialPrice) updateDisplay(initialPrice, initialTime);
    async function pollPrice() {
      try {
        const res = await fetch('/price');
        if(res.ok) {
          const data = await res.json();
          if(data.price) updateDisplay(data.price, data.time);
        }
      } catch(e) { console.error(e); }
      setTimeout(pollPrice, 1000);
    }
    pollPrice();
  </script>
</body>
</html>
